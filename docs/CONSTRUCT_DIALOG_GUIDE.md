# CONSTRUCT Dialog Implementation Guide

## Overview
The `utils_global_lkup.4gl` module now includes a powerful CONSTRUCT dialog feature that allows users to perform advanced searches using SQL-like query patterns with wildcards and operators.

## What is CONSTRUCT?
CONSTRUCT is a Genero 4GL feature that allows users to build WHERE clauses interactively. Instead of simple text search, users can:
- Use wildcards (`%` for multiple characters, `_` for single character)
- Use comparison operators (`>`, `<`, `>=`, `<=`, `!=`)
- Use ranges (`BETWEEN`, `IN`)
- Combine multiple criteria across columns

## Implementation Details

### New Functions Added

#### 1. `display_lookup_with_construct(p_lookup_code STRING) RETURNS STRING`
Main function that displays a lookup window with CONSTRUCT capabilities.

**Example:**
```4gl
DEFINE selected_id STRING
LET selected_id = utils_global_lkup.display_lookup_with_construct("stock")
```

#### 2. `load_lookup_data_with_where(p_base_sql STRING, p_arr DYNAMIC ARRAY, p_where STRING)`
Internal function that loads data based on the WHERE clause generated by CONSTRUCT.

### Convenience Functions (Shortcuts)

All original lookup functions now have `_construct` versions:

```4gl
-- Simple search (original)
utils_global_lkup.lookup_stock()

-- Advanced search with CONSTRUCT
utils_global_lkup.lookup_stock_construct()
```

Available shortcuts:
- `lookup_customer_construct()`
- `lookup_creditor_construct()`
- `lookup_stock_construct()`
- `lookup_uom_construct()`
- `lookup_pu_ord_construct()`
- `lookup_pu_inv_construct()`
- `lookup_stock_category_construct()`
- `lookup_warehouse_construct()`
- `lookup_bin_construct()`
- `lookup_users_construct()`

## User Experience

### How Users Interact with CONSTRUCT

1. **Opening the Dialog**
   - When the lookup window opens, users see three search fields (col1, col2, col3)
   - These correspond to the columns configured in `sy08_lkup_config` table

2. **Entering Search Criteria**
   Users can enter various types of searches:

   **Simple wildcards:**
   - `%smith%` - finds any value containing "smith"
   - `john%` - finds values starting with "john"
   - `%son` - finds values ending with "son"

   **Exact matches:**
   - `123` - finds exact ID 123
   - `"Active"` - finds exact text match

   **Ranges:**
   - `>100` - finds IDs greater than 100
   - `<50` - finds IDs less than 50
   - `>=100 AND <=200` - finds IDs between 100 and 200

   **Multiple values:**
   - `100|200|300` - finds IDs 100, 200, or 300

3. **Actions Available**
   - **Search** - Execute the search with current criteria
   - **Reset** - Clear all criteria and show all records
   - **Accept** - Select the highlighted record and return
   - **Cancel** - Close without selecting

4. **Results Display**
   - Results appear in the table below
   - Double-click or press ACCEPT to select a record
   - Message shows count of matching records

## Example Usage in Your Code

### Example 1: Using in Stock Master Form
```4gl
-- In st101_mast.4gl
ON ACTION Find_Advanced
    DEFINE selected_stock_id STRING

    LET selected_stock_id = utils_global_lkup.lookup_stock_construct()

    IF selected_stock_id IS NOT NULL THEN
        CALL load_stock_item(selected_stock_id)
    END IF
```

### Example 2: Using in Invoice Entry
```4gl
-- In sa132_invoice.4gl
ON ACTION lookup_customer ATTRIBUTES(TEXT="Advanced Search", IMAGE="zoom")
    DEFINE selected_cust_id STRING

    LET selected_cust_id = utils_global_lkup.lookup_customer_construct()

    IF selected_cust_id IS NOT NULL THEN
        LET l_hdr.cust_id = selected_cust_id
        CALL load_customer_details(selected_cust_id)
        DISPLAY BY NAME l_hdr.cust_id
    END IF
```

### Example 3: Providing Choice to User
```4gl
-- Give users both simple and advanced search options
MENU "Search Options"
    COMMAND "Quick Search"
        LET selected_id = utils_global_lkup.lookup_stock()

    COMMAND "Advanced Search"
        LET selected_id = utils_global_lkup.lookup_stock_construct()

    COMMAND "Cancel"
        EXIT MENU
END MENU
```

## Configuration

The CONSTRUCT dialog uses the same configuration as the simple search, stored in `sy08_lkup_config`:

| Column | Purpose |
|--------|---------|
| `lookup_code` | Unique identifier (e.g., "stock", "customer") |
| `table_name` | Source table name |
| `key_field` | Column to return (usually ID) |
| `desc_field` | Description column to display |
| `extra_field` | Additional column (optional) |
| `display_title` | Window title |
| `col1_title` | Label for column 1 |
| `col2_title` | Label for column 2 |
| `col3_title` | Label for column 3 |

## Benefits of CONSTRUCT

1. **Power User Friendly** - Advanced users can perform complex searches
2. **Flexible** - Supports all SQL WHERE clause operators
3. **Efficient** - Server-side filtering reduces network traffic
4. **User-Friendly** - Simple for basic searches, powerful for advanced
5. **Consistent** - Same interface across all lookup types

## Migration Strategy

### Keep Both Options
The original simple search functions still exist, so you can:
1. Keep using `display_lookup()` for simple searches
2. Use `display_lookup_with_construct()` for advanced searches
3. Provide both options to users based on their needs

### No Breaking Changes
All existing code continues to work. The CONSTRUCT functionality is an addition, not a replacement.

## Technical Notes

### WHERE Clause Generation
- CONSTRUCT automatically generates SQL-safe WHERE clauses
- No SQL injection risk - uses proper parameter binding
- Handles NULL values correctly
- Supports column aliasing (c1, c2, c3)

### Performance
- Uses prepared statements for efficiency
- Cursor-based iteration for large result sets
- Indexes on search columns recommended for best performance

### Error Handling
- All database operations wrapped in TRY/CATCH
- User-friendly error messages
- Graceful fallback on errors

## Testing

To test the CONSTRUCT implementation:

1. **Compile the module:**
   ```bash
   fglcomp -M src/utils/utils_global_lkup.4gl -o bin/utils_global_lkup.42m
   ```

2. **Test in your application:**
   - Call `utils_global_lkup.lookup_stock_construct()`
   - Try various search patterns
   - Verify results match expectations

3. **Test cases to try:**
   - Search with wildcards: `%test%`
   - Search with ranges: `>100`
   - Search across columns
   - Reset functionality
   - Cancel operation

## Future Enhancements

Potential improvements:
- Save/load search templates
- Search history
- Export results
- Multi-column sorting
- Custom sort order

---

**Author:** Bongani Dlamini
**Version:** 1.0
**Date:** 2025-11-26
**Module:** utils_global_lkup.4gl
