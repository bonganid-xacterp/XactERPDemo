-- ==============================================================
-- Program   : 130_quote.4gl
-- Purpose   : Sales Quote Program
-- Module    : Sales Quote (sa)
-- Number    : 130
-- Author    : Bongani Dlamini
-- Version   : Genero ver 3.20.10
-- ==============================================================

IMPORT ui
IMPORT FGL utils_globals
IMPORT FGL st121_st_lkup
IMPORT FGL utils_doc_totals
IMPORT FGL dl121_lkup
--IMPORT FGL dl101_mast


SCHEMA demoapp_db

-- ==============================================================
-- Record Definitions
-- ==============================================================
TYPE qt_hdr_t RECORD LIKE sa30_quo_hdr.*
TYPE debt_t RECORD LIKE dl01_mast.*
 
DEFINE m_rec_qt qt_hdr_t
DEFINE m_debt_mast debt_t 

DEFINE m_arr_qt_lines DYNAMIC ARRAY OF RECORD LIKE sa30_quo_det.*

DEFINE m_arr_codes DYNAMIC ARRAY OF STRING
DEFINE m_curr_idx INTEGER

-- ==============================================================
-- Add or Edit an quote line
-- ==============================================================
FUNCTION new_quote()
    DEFINE l_hdr RECORD LIKE sa30_quo_hdr.*                    
    DEFINE l_arr_lines DYNAMIC ARRAY OF RECORD LIKE sa30_quo_det.*
    DEFINE l_new_line RECORD LIKE sa30_quo_det.*

    DEFINE l_next_doc_no INTEGER
    DEFINE l_stock_code STRING
    DEFINE l_cost, l_price DECIMAL(15,2)

    DEFINE l_idx INTEGER

    -- ==========================================================
    -- 1. Generate next document number
    -- ==========================================================
    SELECT COALESCE(MAX(doc_no), 0) + 1 INTO l_next_doc_no
      FROM sa30_quo_hdr

    LET l_hdr.doc_no = l_next_doc_no
    LET l_hdr.trans_date = TODAY
    LET l_hdr.status = "NEW"
    LET l_hdr.created_at = CURRENT
    LET l_hdr.created_by = utils_globals.get_current_user_id()
    LET l_hdr.gross_tot = 0
    LET l_hdr.vat = 0
    LET l_hdr.disc = 0
    LET l_hdr.net_tot = 0

    CALL l_arr_lines.clear()

    -- ==========================================================
    -- 2. Open quote entry form
    -- ==========================================================
    OPEN WINDOW w_quote WITH FORM "sa130_quote" ATTRIBUTES(STYLE="dialog")

    CALL utils_globals.set_form_label("lbl_form_title", "New Sales Quote")

    -- ==========================================================
    -- 3. Enter Quote Header
    -- ==========================================================
    DIALOG
        INPUT BY NAME l_hdr.*
            BEFORE FIELD acc_code
                -- Customer lookup (optional popup)
                 CALL utils_globals.get_next_code("sa30_quo_hdr", "acc_code")
                    RETURNING l_next_doc_no
                --CALL dl101_mast.load_all_debtors()
                
            ON ACTION next ATTRIBUTES(TEXT="Next", IMAGE="next")
                -- Go to lines input once header is ready
                EXIT DIALOG

            ON ACTION cancel ATTRIBUTES(TEXT="Cancel", IMAGE="exit")
                CALL utils_globals.show_info("Quote creation cancelled.")
                RETURN  
        END INPUT
        
    END DIALOG

    -- ==========================================================
    -- 4. Enter Quote Lines
    -- ==========================================================
    DIALOG
        DISPLAY ARRAY l_arr_lines TO arr_sa_quote_lines.*
            BEFORE DISPLAY
                CALL DIALOG.setActionHidden("accept", TRUE)

            -- --------------------------------------------------
            -- Add new quote line
            -- --------------------------------------------------
            ON ACTION add ATTRIBUTES(TEXT="Add Line", IMAGE="new")

                INITIALIZE l_new_line.* TO NULL
                LET l_new_line.hdr_id = l_hdr.id
                LET l_new_line.line_no = l_arr_lines.getLength() + 1

                DIALOG
                    INPUT BY NAME l_new_line.stock_code, l_new_line.qnty, 
                                   l_new_line.unit_cost, l_new_line.sell_price, 
                                   l_new_line.disc, l_new_line.vat
                        BEFORE FIELD stock_code
                            LET l_stock_code = st121_st_lkup.display_stocklist()
                            IF l_stock_code IS NOT NULL THEN
                            
                                LET l_new_line.stock_code = l_stock_code
                                
                                --CALL load_stock_defaults(l_stock_code, l_cost, l_price, l_desc)
                                
                                LET l_new_line.unit_cost = l_cost
                                LET l_new_line.sell_price = l_price
                                DISPLAY BY NAME l_new_line.unit_cost, l_new_line.sell_price
                            END IF

                        AFTER FIELD qnty, unit_cost, sell_price, disc, vat
                            LET l_new_line.line_tot = utils_doc_totals.calc_line_total(
                                l_new_line.qnty,
                                l_new_line.sell_price,
                                l_new_line.disc,
                                l_new_line.vat
                            )
                            DISPLAY BY NAME l_new_line.line_tot

                        ON ACTION save ATTRIBUTES(TEXT="Save Line", IMAGE="save")
                            LET l_arr_lines[l_arr_lines.getLength() + 1].* = l_new_line.*
                            CALL utils_globals.msg_saved()
                            EXIT DIALOG

                        ON ACTION cancel
                            EXIT DIALOG
                    END INPUT
                END DIALOG

            -- --------------------------------------------------
            -- Edit existing line
            -- --------------------------------------------------
            ON ACTION edit ATTRIBUTES(TEXT="Edit Line", IMAGE="pen")
                LET l_idx = arr_curr()
                IF l_idx > 0 THEN
                    --CALL edit_quote_line(l_arr_lines[l_idx])
                END IF

            -- --------------------------------------------------
            -- Delete line
            -- --------------------------------------------------
            ON ACTION delete ATTRIBUTES(TEXT="Delete Line", IMAGE="delete")
                IF arr_curr() > 0 THEN
                    --CALL utils_globals.confirm_delete(arr_curr(), 0)
                    CALL l_arr_lines.deleteElement(arr_curr())
                    CALL utils_globals.msg_deleted()
                END IF

            -- --------------------------------------------------
            -- Save header + lines
            -- --------------------------------------------------
            ON ACTION save ATTRIBUTES(TEXT="Save Quote", IMAGE="save")
               -- CALL save_quote(l_hdr, l_arr_lines)
                CALL utils_globals.msg_saved()
                EXIT DIALOG

            ON ACTION cancel
                CALL utils_globals.show_info("Quote cancelled.")
                EXIT DIALOG
        END DISPLAY
    END DIALOG

    CLOSE WINDOW w_quote
END FUNCTION


-- ==============================================================
-- Add or Edit an quote line
-- ==============================================================
FUNCTION edit_or_add_qt_line(p_doc_id INTEGER, p_row INTEGER, p_is_new SMALLINT)
    DEFINE l_line RECORD LIKE sa30_quo_det.*
    DEFINE l_stock_code STRING
    DEFINE l_vat_rate DECIMAL(10,2)
    DEFINE l_gross, l_net, l_vat DECIMAL(15,2)
    
    -- Initialize new line
    IF p_is_new THEN
        INITIALIZE l_line.* TO NULL
        LET l_line.hdr_id = p_doc_id
        LET l_line.line_no = m_arr_qt_lines.getLength() + 1
        LET l_vat_rate = 15.00
    ELSE
        -- Load from existing array line
        LET l_line.* = m_arr_qt_lines[p_row].*
        LET l_vat_rate = 15.00
    END IF

    -- ==============================
    -- Input Dialog for editing/adding
    -- ==============================
    DIALOG
        INPUT BY NAME l_line.stock_code, l_line.qnty, l_line.disc, l_line.vat
            ATTRIBUTES(WITHOUT DEFAULTS)

            BEFORE FIELD stock_code
                -- call lookup popup
                LET l_stock_code = lookup_stock_item()
                
                IF l_stock_code IS NOT NULL THEN
                
                    LET l_line.stock_code = l_stock_code
                    
                    CALL load_stock_defaults(l_stock_code, l_line.unit_cost, l_line.sell_price)

                    DISPLAY BY NAME l_line.unit_cost, l_line.sell_price
                    
                END IF

            AFTER FIELD qnty, disc, vat
                -- calculate the line total 
                LET l_line.line_tot =  utils_doc_totals.calc_line_total(
                                    l_line.qnty, 
                                    l_line.unit_cost, 
                                    l_line.disc, 
                                    l_line.vat
                )
                
                DISPLAY BY NAME l_line.line_tot, l_line.vat

            ON ACTION save
                IF p_is_new THEN
                    LET m_arr_qt_lines[m_arr_qt_lines.getLength() + 1].* = l_line.*
                ELSE
                    LET m_arr_qt_lines[p_row].* = l_line.*
                END IF
                CALL utils_globals.msg_saved()
                EXIT DIALOG

            ON ACTION cancel
                EXIT DIALOG
        END INPUT
    END DIALOG
END FUNCTION

-- ==============================================================
-- Lookup item from Stock Master
-- ==============================================================
PRIVATE FUNCTION lookup_stock_item() RETURNS STRING
    DEFINE l_stock_code STRING
    LET l_stock_code = st121_st_lkup.display_stocklist() -- your lookup popup
    RETURN l_stock_code
END FUNCTION

-- ==============================================================
-- Lookup item from Stock Master
-- ==============================================================
PRIVATE FUNCTION load_stock_defaults(p_stock_code STRING, p_cost DECIMAL, p_price DECIMAL)
    SELECT cost_price, sell_price
      INTO p_cost, p_price
      FROM st01_mast
     WHERE stock_code = p_stock_code

    IF SQLCA.SQLCODE != 0 THEN
        LET p_cost = 0
        LET p_price = 0
    END IF
END FUNCTION

-- ==============================================================
-- Delete selected quote line
-- ==============================================================
FUNCTION delete_qt_line(p_doc_id INTEGER, p_row INTEGER)
    IF p_row > 0 THEN
        IF utils_globals.confirm_delete(p_row, p_doc_id) THEN
            CALL m_arr_qt_lines.deleteElement(p_row)
            CALL utils_globals.msg_deleted()
        END IF
    END IF
END FUNCTION

-- ==============================================================
-- Save all lines to database
-- ==============================================================
FUNCTION save_qt_lines(p_doc_id INTEGER)
    DEFINE i INTEGER

    DELETE FROM sa30_quo_det WHERE hdr_id = p_doc_id

    FOR i = 1 TO m_arr_qt_lines.getLength()
        INSERT INTO sa30_quo_det VALUES m_arr_qt_lines[i].*
    END FOR
END FUNCTION

-- ==============================================================
-- Function : load_customer
-- ==============================================================
PRIVATE FUNCTION load_customer(p_acc_code STRING)

    DEFINE rec_cust RECORD
        cust_name LIKE dl01_mast.cust_name,
        phone     LIKE dl01_mast.phone,
        email     LIKE dl01_mast.email,
        address1  LIKE dl01_mast.address1,
        address2  LIKE dl01_mast.address2,
        address3  LIKE dl01_mast.address3,
        postal_code LIKE dl01_mast.postal_code
    END RECORD

    SELECT cust_name, phone, email, address1, address2, address3, postal_code
      INTO rec_cust.*
      FROM dl01_mast
     WHERE acc_code = p_acc_code

    IF SQLCA.SQLCODE = 0 THEN
        DISPLAY BY NAME rec_cust.*
    ELSE
        CALL utils_globals.show_error("Customer not found for account " || p_acc_code)
    END IF
END FUNCTION

-- ==============================================================
-- Function : load_quote
-- ==============================================================
FUNCTION load_quote(p_doc_id INTEGER)
    DEFINE idx INTEGER
    DEFINE user_choice SMALLINT

    OPTIONS INPUT WRAP

    -- Open window and attach form
    OPEN WINDOW w_qt WITH FORM "sa130_quote" ATTRIBUTES(STYLE = "dialog")

    -- Initialize variables
    INITIALIZE m_rec_qt.* TO NULL
    CALL m_arr_qt_lines.clear()

    -- ===========================================
    -- Load header record
    -- ===========================================
    SELECT * INTO m_rec_qt.* 
      FROM sa30_quo_hdr 
     WHERE id = p_doc_id

    IF SQLCA.SQLCODE = 0 THEN
        -- ===========================================
        -- Load quote lines
        -- ===========================================
        LET idx = 0
        DECLARE ord_lines_cur CURSOR FOR
            SELECT * 
              FROM sa30_quo_det 
             WHERE hdr_id = p_doc_id 
             ORDER BY line_no

        FOREACH ord_lines_cur INTO m_arr_qt_lines[idx + 1].*
            LET idx = idx + 1
        END FOREACH

        CLOSE ord_lines_cur
        FREE ord_lines_cur

        -- ===========================================
        -- Show form in view mode first
        -- ===========================================
        DISPLAY BY NAME m_rec_qt.*
        DISPLAY ARRAY m_arr_qt_lines TO arr_sa_qt_lines.*

            BEFORE DISPLAY
                CALL DIALOG.setActionHidden("cancel", TRUE)
                CALL DIALOG.setActionHidden("accept", TRUE)

            ON ACTION edit ATTRIBUTES(TEXT="Edit quote", IMAGE="pen")
                LET user_choice = prompt_edit_choice()

                CASE user_choice
                    WHEN 1
                        CALL edit_qt_header(p_doc_id)
                        DISPLAY BY NAME m_rec_qt.*  -- Refresh
                    WHEN 2
                        CALL edit_qt_lines(p_doc_id)
                    OTHERWISE
                        CALL utils_globals.show_info("Edit cancelled.")
                END CASE

            ON ACTION close ATTRIBUTES(TEXT="Close", IMAGE="exit")
                EXIT DISPLAY
        END DISPLAY
    ELSE
        CALL utils_globals.show_error("quote not found.")
    END IF

    CLOSE WINDOW w_qt
END FUNCTION

-- ==============================================================
-- Prompt Edit Choices
-- ==============================================================
PRIVATE FUNCTION prompt_edit_choice() RETURNS SMALLINT
    DEFINE choice SMALLINT

    MENU "Edit Quote"
        COMMAND "Header"
            RETURN 1
        COMMAND "Lines"
            RETURN 2
        COMMAND "Cancel"
            RETURN 0
    END MENU

    RETURN choice
    
END FUNCTION

-- ==============================================================
-- Edit quote header
-- ==============================================================
FUNCTION edit_qt_header(p_doc_id INTEGER)
    DEFINE new_hdr RECORD LIKE sa30_quo_hdr.*

    LET new_hdr.* = m_rec_qt.*

    DIALOG
        INPUT BY NAME new_hdr.*
        
            ON ACTION save
            
                UPDATE sa30_quo_hdr SET sa30_quo_hdr.* = new_hdr.* 
                 WHERE id = p_doc_id
                LET m_rec_qt.* = new_hdr.*
                
                CALL utils_globals.msg_saved()

            ON ACTION cancel
                EXIT DIALOG
        END INPUT
        
    END DIALOG
END FUNCTION


FUNCTION edit_qt_lines(p_doc_id INTEGER)
    DIALOG
        DISPLAY ARRAY m_arr_qt_lines TO arr_sa_qt_lines.*
            BEFORE DISPLAY
                CALL DIALOG.setActionHidden("accept", TRUE)

            ON ACTION add ATTRIBUTES(TEXT="Add Line", IMAGE="new")
                CALL edit_or_add_qt_line(p_doc_id, 0, TRUE)

            ON ACTION edit ATTRIBUTES(TEXT="Edit Line", IMAGE="pen")
                CALL edit_or_add_qt_line(p_doc_id, arr_curr(), FALSE)

            ON ACTION delete ATTRIBUTES(TEXT="Delete", IMAGE="delete")
                CALL delete_qt_line(p_doc_id, arr_curr())

            ON ACTION save ATTRIBUTES(TEXT="Save", IMAGE="save")
                CALL save_qt_lines(p_doc_id)
                CALL utils_globals.msg_saved()
                EXIT DIALOG

            ON ACTION cancel
                EXIT DIALOG
        END DISPLAY
    END DIALOG
END FUNCTION

-- ==============================================================
-- Save quote (Header + Lines)
-- ==============================================================
FUNCTION save_quote()
    DEFINE exists INTEGER

    SELECT COUNT(*) INTO exists FROM sa30_quo_hdr WHERE id = m_rec_qt.id

    IF exists = 0 THEN
        INSERT INTO sa30_quo_hdr VALUES m_rec_qt.*
        CALL utils_globals.msg_saved()
    ELSE
        UPDATE sa30_quo_hdr
            SET sa30_quo_hdr.* = m_rec_qt.*
            WHERE id = m_rec_qt.id
        CALL utils_globals.msg_updated()
    END IF

    -- Save lines
    DELETE FROM sa30_quo_det WHERE hdr_id = m_rec_qt.id

    FOR m_curr_idx = 1 TO m_arr_qt_lines.getLength()
        INSERT INTO sa30_quo_det VALUES m_arr_qt_lines[m_curr_idx].*
    END FOR

END FUNCTION

-- ==============================================================
-- Delete quote
-- ==============================================================
FUNCTION delete_quote(p_doc_id INTEGER)
    DEFINE ok SMALLINT

    IF p_doc_id IS NULL THEN
        CALL utils_globals.show_info("No quote selected for deletion.")
        RETURN
    END IF

    LET ok = utils_globals.show_confirm("Delete this quote?", "Confirm Delete")

    IF NOT ok THEN
        CALL utils_globals.show_info("Delete cancelled.")
        RETURN
    END IF

    DELETE FROM sa30_quo_det WHERE hdr_id = p_doc_id
    DELETE FROM sa30_quo_hdr WHERE id = p_doc_id
    CALL utils_globals.msg_deleted()
END FUNCTION

-- ==============================================================
-- Navigation
-- ==============================================================
PRIVATE FUNCTION move_record(dir SMALLINT)
    DEFINE new_idx INTEGER

    IF m_arr_codes.getLength() == 0 THEN
        CALL utils_globals.show_info("No records to navigate.")
        RETURN
    END IF

    LET new_idx = utils_globals.navigate_records(m_arr_codes, m_curr_idx, dir)
    LET m_curr_idx = new_idx
    CALL load_quote(m_arr_codes[m_curr_idx])
END FUNCTION
